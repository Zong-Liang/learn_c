# 01_内存组织方式

## 数据的存放方式

程序编写完成后，需要先装载到计算机的内核或者半导体内存中，然后才能运行。计算机程序一般被组织成4个逻辑段：可执行代码、静态数据、动态数据（堆）和栈。

- 可执行代码和静态数据存储在固定的内存位置。
- 动态数据需要系统动态分配内存，一般存放在堆区的内存池中。
- 局部数据对象、函数参数，以及调用函数和被调用函数的联系，存放在栈区的内存池中。

## 堆与栈

### 堆

内存的全局存储空间中，程序可动态分配和释放的内存块称为自由存储空间，也称为堆。C程序中，用`malloc`和`free`函数来从堆中动态地分配和释放内存。

### 栈

程序不会像处理堆那样，在栈中显式地分配内存。当程序调用函数和声明局部变量时，系统将自动分配内存。栈是一个后进先出的“压入弹出式”数据结构。程序运行时，每向栈中压入一个对象，栈指针就会向下移动一个位置。当系统从栈中弹出一个对象时，最晚进栈的对象将被先弹出，然后栈指针向上移动一个位置。如果栈指针位于栈顶，则表示栈是空的；如果栈指针指向最下方数据项的后一个位置，则表示栈为满的。

程序员经常利用栈处理那些适合用“后进先出”逻辑描述的编程问题。栈不需要程序员编写代码去维护，而是运行时由系统自动处理。系统自动维护和后进先出是栈区别于堆的显著标志。

栈是如何工作的呢？通过函数调用来看一下栈的整体操作过程。当函数A调用函数B时，系统将会把函数A的所有实参和返回地址压入栈中，栈指针将移到合适的位置来容纳这些数据。最后进栈的是函数A的返回地址。

当函数B开始执行后，系统把函数B的自变量压入栈中，并把栈指针再向下移，以保证有足够的空间来存储函数B声明的所有自变量。当函数A的实参压入栈后，函数B就在栈中以自变量形式建立了形参。函数B内部的其他自变量也是存放在栈中的。由于这些进栈操作，栈指针已经移到了所有局部变量之下。但是函数B记录了刚开始执行时的初始栈指针，以这个指针为参考，用正偏移量或负偏移量来访问栈中的变量。

当函数B准备返回时，系统会弹出栈中的所有自变量，这时栈指针移到了函数B刚开始执行时的位置。接着，函数B返回，系统从栈中弹出返回地址，函数A就可以继续执行了。当函数A继续执行时，系统还能从栈中弹出调用者的实参，于是栈指针又回到了调用发生前的位置。
